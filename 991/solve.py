#!/usr/bin/env python3
from Crypto.Util.number import *
import json

# ========== Challenge A: Basic RSA Decryption ==========
def solve_A():
    e = 65537
    N = 11047053353463208177637870870117853485806239562001836762079480023185382580500106811033386681660121894354105236930221603813331944288454167770881790942915397944935779725671408573472956757917463568920917929995162800636522890399964159326613111980734167437356419804714357332751322461169019695707490493858841964365886582399722999653900630567927359895281565419754557098332927729287764716668908301469052556757075468332351142952473077665457385406434465132684734336219547980900472004115395019343011577533306189895428936474683300901381723885928732465302291195465398369993266027799013117933232156415573397074259892062869965584407
    d = 8810571611946967792803361040483850097648753157243602937533490109890241574990617252939623242804719643804182776585833239387201846224471838735618358038897797201334334352825409382896043102058194657734218216929630047552839082629899547489856733602712882765204124491090753977532979442495742717471578201985257345246646898740794905307755332755228104689160611186579883574545548204845025477057884356132177284037875434827887983594433442717250234649861979735702763569514144721308499992134392122015632097705556270988734375008936049754228243273321889827088066376146074376111168456949245957690301249888753061563474013357822724614513
    c = 7032305208378037196381537823235451121510328723009214502835488130802896657661907859319980096347977203046488841119157479814242968047704425063194127400207429428805534176000468563240285938977798788603958883669079512136069206836266185667173340300539792177560726830511819474437718259338957911302026758986770394028771825860345363160122852239369213157845671128412563642096143528818427429800325424492079656419197078221982309665321705207551374998292814625708705500616494347637798234573839811096749509772577094142087305732048065436832340506344074052586178248900480313901244858721681015993103714222981390519492447304101912545948
    
    m = pow(c, d, N)
    flag = long_to_bytes(m)
    return flag.decode()

# ========== Challenge B: Leaked p ==========
def solve_B():
    e = 65537
    N = 25726702851381190683908286843825837024899813295374495789750575871139065912808047364920170440932535089645297575805324023895465215718743183273997168282673453460887046535102604526344768029633910545970398961444806242155657206567726404869536735614077711662936300322239608249390947202825024279428251685438160844899134355508067464564315315091350103850823970553115423337530045994064826568250646001470661104541845821914635647987304586778234983605924175685520016131547971689358791081906936920958934930610591918816402363542183212591791605553833402685071883971163652650503317553592461395942698861250837447139861025156466950809701
    c = 10182538023611630262943921275464550825614337435078685743303829501520123295850845292976290328833920515908378055490745236261834595366705436084508841247769496863508368597623318867122921088729115077769244114730026496416280876981965465828997858284944539055651865860467730471002699226367608412286248967182901352790777266524489840520070322173836052463512324704892846542161524745978046575004893591245293846330082719563851644295444933389267086415960099787556010123993018666710367224633418674557058998896754481426302830102398800087961079894884638906989897191796547575996040197858265553055769024574685471743312024621351705802297
    p = 144828531230691548398555983453510598498941185153276829867151024051467656089277117850562490775322297989097298857448947412668017227537038576831138530305465108240257459608035469469061293625236562077012131009946751020388019354534800213150061485517328284097456130349882393338596645931462978300575657167242934526193
    
    q = N // p
    phi = (p - 1) * (q - 1)
    d = pow(e, -1, phi)
    m = pow(c, d, N)
    flag = long_to_bytes(m)
    return flag.decode()

# ========== Challenge C: RSA Signature Attack ==========
def solve_C():
    # Public keys
    keys = {
        'Arnold': (65537, 13224988612605195032569809357081161974462950068791253474562840488917849531005913748961440715531372455317550406037542584766807493688876628277568265586171533075339182053234256360762989768492193205878060749275419923684265336383300320811306521438941530340930677502385554531468871329675703527624800977452888981365734895467253160166042936652133968963795503821079470524588509221261587613249676591169477637759678006333317989369560122136677993888027253737681311894741818946418390782870600579418196948396123510145960346501822734583248396911918574821713982806291538113807481674910512198621360286368806399097040401110175393105073),
        'Brenda': (65537, 22580189795350823013632661663682296164864664310134529227084376584345900899644529936190222833975179328685615695229287728617238962853207827474506154317769637116660680571462978813304827587936592560560302427061233228771155615407028297796155062007512401304098804323500961168701529169504696874810856879019155474247111017631515883259046460560444723839207276683513177462498683209000769066042658625856877192024063294753788843052742545295347730941743939796624623499051424452085614197363359922498599267187416475859482570214902784851559628564421217260636616998552810699367252689088587488198052619894245746258478815323259302111699),
        'Cody': (65537, 15280356360380337192680871354618628042291181545182389981291882938408226706482906294657300387764151260489965847088165162527878551866659193165765279161893020644469556907268537612538183036362000902642987373454595623696820351150898893858730594784301392141568068185335904174250010330427170776060097136877639553777728484540866090051951155106954718285700962556277156268849920694298571268870174453252608752071051222500828513105820066402091529954328683600799278519836142261389494459476821834113457092798925786268945065675815975986645612378585452783483582629648301643914060801317415885675958057599624956922188009009316569675413),
        'Dreamy': (65537, 19484853347878840388162602255561200125189909368805311656951174728087510272387073392270513757011259506070227743728821803772768980167602145997934251342110777688605903481915190234946331761251392914264546241436005433927510807344230170995358548005190178868436528842367788096796203236168027867700231778975157817639555216294014736882244861053245222534389373174074314750237377849691439652327399769389361796900900648018017436499515245508937437818243608758121319784055628405278126002961829434188780243787128732892132800258721622936155221679290733788217303914788860703178165203282988571704181927029769343021526607411124008644823),
        'Edward': (65537, 31205397863471697744337206858305241615416114035307324331686528597725608942796622533247327272120662437583585264616943859362200975544861679706056482579635084835801558115460812213286375768508815117424171694184047156805091610232220691164577042296482379626785518630021518468396936839035285782915053635519721355289366929736557096696584029813756297378338307752989012972111503472185537726450774068490833746539746975475865560009062485184763864875375064540724073652070297429488473003496282386327142164752949776611089169500719024955734613864969534647291484224502525628277358206900408485547717608221706866245822995611589304302227),
        'Fiora': (65537, 20562650075915258026284945921418869312005437118064530967616463924896345371110052851605632287195249035169702319101504040136744383244052044936784697944320319282100547771424307145665107964399934493521301611026098397972833848960825767660006612355863058423024933380074702142694878368028990539640120016965834949692127254407577801183343985909426371894176919916879151723967908158093240695601113530840442117267116067363353314573507384490403468222808433524527234237289881902568210698967415533697488680129855037437033035349793049425301558621857577899683305529033323962171740222881310296892606216426743061059985901924521197144573)
    }
    
    signatures = [
        10246450345033517771528995316294717809197535908129417978655072432219421475877436281449587317035511925875238368239354674460120469508939448546889611885705911238570312951762961952827697167122810618459143268020597681602493922828164912343816068484211609928955121130943206317217466149687797291398004727143515248367213040551775563461382416053231591112327862008512823365623565320676221923870370682812391650595624636797134087563338899397255421184939921065380335917349673879352876310244949640526546663828637072528546338650928048560397099167279723436236472957270749505051419937169292534346037250381571922244807900770204551673887,
        6543518330127428969030689696812953501062620386121510379774202224531468156712390262653094852450372274705289191202797264467546802015230544676575701993208555039326666698779258164293487792819292340893866144445021416266988782847749116748502367425608686213227981260072813201898988286108733195084103417391742213900878434083132762133371406425578006182290502649903108960405910016600099217397187124139771158991265984053243070526627195745412656045840369497222090991122575735338735919162101261946301065277690255426181995940277868517780446274559958412514819741405635849007847933873548555502970850290903065808040597875661150269804,
        1124185265207912373235431522225371763504290388665523645660776568318159097557951343062947625229096626578632268605886311064516844737954659467544205678460849297161785654195780242894681524505877366503744513938827599021702359988456864156783451103800018385384328935808593758600407108230723365814181186664434805753917599923265648504579088232358524717254235724688690342120198762523729431642932570256642830305067353525830603205835979587282694782265336908710146516312314804397536860870701525110472908647296647668164683692521113895750350542187773334560413520502104728885380527336823385351979712969239876089109569855941370207233,
        2553787117972345836469775092932303734470511140960024278147563674278785111498146389695296941307795482834561292660126506337893304053685477931801243651321789590351556076800724281191756798904613886593877084750474220189199591914581646870128370882171181340011404646033918404202859907517864925432367190379274532239408523973168268610416190140276453514730942580621949211547988784824797168292181157342409494249536647385149759125655427571285175507342725096677364849959075450344583021040092061356648790709137308017962287232316244158006101738245884562628808267675110669853478784698352225323205763787527131594543399264312960095502,
        27570337792529811417998408996520445966683010391711882961986008922043474020023562029512076031544714682765438184250973387235910797450749450031495787928694514378905441865706583686518342191467185751784265758386964159844569001166871302264180767906651803470984488696514324409656400112630031410690133331707287006285193782279868315397239173274012593581513780286601546719573505902615383122692338291508760441627038287170518465501540140258895435780911889961451227008212352663730152144502379502277343587741664515480833646875468004081318754688247079069917075204609250015649342162483666333900899825579607997419757303002578800768098,
        17623545210351467277210037634234601270351301324407139800562570828743887911718952327993241609178391529664000311597790936294287909968883266728124443359414747846938585784566108751626650559586248041197794174624663034279040048390576868758987437085287921654613534190870928580456315548193963351741045757504776205210893586957780288242061238077217712211887528550323020093385813956055892540212452932535393231291540313696858872371857936946671331161851089578806186308544559223013985245262176475739720792542874212399539118177351539591724851266835114228140703306503887213139455457478211891277110559295968285293443747460529854222326
    ]
    
    # Try to verify which signature belongs to Cody
    e, N = keys['Cody']
    
    for sig in signatures:
        m = pow(sig, e, N)
        try:
            msg = long_to_bytes(m)
            if b'CH{' in msg:
                return msg.decode()
        except:
            pass
    
    return "Not found"

# ========== Challenge P: Small e (e=3) ==========
def solve_P():
    print("\n[P] Small e (e=3) Attack")
    e = 3
    N = 19884222029764619856532189569404376250563156767748276904201712582929458763811990805976375288644992872765358677421386172580952512357387868439272848350518674967735890302784777077355491775124178999369281334775117061754279507528522292535789143685913748561525380751289249914737184504972215629334114646454894554760809876240317272935278305302423881582721553631645851649901256376860518455733600691272902950269933309595563731697224609338148608622094118254059701197587558419741525301160892799388260286158885648133441824311292534954776987267816742727389884836879125016847491639196982130616547428396435782301087608123644970478979
    c = 3021707745705914717651932099169168208235712676167718078692122933691485374057028911998943345172521733411101314628815022659490803442844618954413140489295354154403280343517306999272476905608959365312022675566922361996146509039679143309999884410600120110005758740177796709292326142700733840281371633190982454094038156388959584702890861083812792607675801620840354424270070201264834985158396573621234143427485269282752355459780369697551980040208076682409974507477566497326620351766287448951298187046661445171969319487511046743211743696953584137813659320328582183904349337110327298045522698431499403515141426896689036371302
    
    # Integer cube root
    def iroot(n, k):
        u, s = n, n+1
        while u < s:
            s = u
            t = (k-1) * s + n // pow(s, k-1)
            u = t // k
        return u
    
    m = iroot(c, 3)
    flag = long_to_bytes(m)
    return flag.decode()

# ========== Challenge Q: Common Factor Attack ==========
def solve_Q():
    from math import gcd
    
    e1 = 0x00010001
    N1 = 14820358835655403805166744727835109646198997758120128098460399106564576338606902882806412676285620984801702788724778563729957160277614281720108934044239885179544733237771649750376261509062010028689069124879006770977477189970414521308137063349561980620742770768866252557394757738565626654134129964333202722172731831661963329016522145968081804453706063735226978343455755600134636887378815279200548112625268169007713144650505477945219039150207167534323021592772708202774406587628358684959865551408921004173649822258714312344306545200301363723450931934049159377400255812315434339532773280160137830237100327486903131339519
    e2 = 0x00010001
    N2 = 10688586580935793850782483270719095421821835075098856188606808209115653769590610095096197424664685024932998852462132758867882551334180591121208681189094876779746606665901215946939014525197121330950213869968948820689568391301726772099184573121863368011578054358822432645371545396371784645740084210413005600282020574572094413095403437261225549889102419964724724919827878272934507590842225397349321874532060302584710327760642830608594211591451485222571530754637060248062366502146681091842647199261829983247180161304359769480540562570709773965284554357111714970043554405767297138943056309802588522061195299706910705835129
    c1 = 12965028638430221892824600410205990847205895805659714920870622144317728450736629957404913738140976107115118078152412720963333817291896427505412005323298264020548126476424720758374037878049974620017138171434355672607721977096114371775561141574394086456451829680809471219433866043609552468347441664500118995921171843779871504711495559978461495073662038766070760732824412871611118592519182229106814992129779581676891026062487762695574049458754525649920499246129445140391313744755269174242149206882730112735463415399138449639895336036933340552490128516690224318903496409372521106668594812925396498388969644759735820636342
    c2 = 7166311577973989394446163500968151125683739001132173404198144822761149435420660534871237335598807556520260507713056822877139358185114511979443711326267216957123908707047014683736031372221216208639275442751149038832697896485815556492838516833151437130997870596378978848101629861591534126005546053605752479044145098458864099038183709784376505693415528428726079137218588277242100204301684533787609534453078254075576127716355804757077498760096428333893160732692062027483589123193326987358368389819035484951501353330564117540191149199754057851138216660387431305442691447340619535909831180079013396875539753967120811898409
    
    # Find common factor p
    p = gcd(N1, N2)
    
    # Get q for both
    q1 = N1 // p
    q2 = N2 // p
    
    # Decrypt both parts
    phi1 = (p - 1) * (q1 - 1)
    d1 = pow(e1, -1, phi1)
    m1 = pow(c1, d1, N1)
    
    phi2 = (p - 1) * (q2 - 1)
    d2 = pow(e2, -1, phi2)
    m2 = pow(c2, d2, N2)
    
    # Combine
    flag = long_to_bytes(m1) + long_to_bytes(m2)
    return flag.decode()

# ========== Challenge R: Common Modulus Attack ==========
def solve_R():
    e1 = 0x00010001
    e2 = 0x00010111
    N = 19541651418205358619802242346309047478636675591878153033367048596806480874319165570321560343830252030852555441569079653907875099374577190255435113061830293291626406312836712523866644945037105341742424605657694906602274739581389373071850402609689950585852789174958835090899380926124333232387457038274404382608447358042207037946958186392145156095551594542692431405870552218631273863177001172891191044820118590892558933309184510683564393484125553068835756763532116490202660052364335529493403975487667026029713115936303870971148737106048690770857703807329645143204197965488819112933302672431481698178136749768729244339907
    c1 = 2003274469879230664598009674216278920821386720795066072791650031493944850126893665852450626262228683502568959124636937507822883004250831198469207330004031385951384691161979080969953673480079625413602403857696640362879257008659581203517064048927327443043881908293219174523981962702499112773561408640112494752938589708985546189036599687304130130697783363653526450555511629237313965265391312966522092955244506378109896667076204928291212275877934883886078757428216354926164947611182263503947817483911604052964608708434919431929973325521497156421936261786089046650977984983283915802950963440214731773312597367575958670006
    c2 = 8721049175243125506726914469225100321544804852668072305241256671294607682624875549441837956089731943596494754361583991832880429869467543685805165278446162189551435715076338377601692043317153490301462055446716202786841785783599112342554833939481737619373868006225829698267368283948637576828814199397378330071862713333637351127812347111603688434513400287166369506982925151784528401997224557534533636052410890482850261778482944651182765242852116273655322284349135250144342275989549238183067842626054223482808883761280459251026940940372141970714305673437738881398891645332312094372545071254455571103585120025216431891599
    
    # Extended Euclidean Algorithm
    def egcd(a, b):
        if a == 0:
            return (b, 0, 1)
        gcd, x1, y1 = egcd(b % a, a)
        x = y1 - (b // a) * x1
        y = x1
        return (gcd, x, y)
    
    gcd, s1, s2 = egcd(e1, e2)
    
    # m = (c1^s1 * c2^s2) mod N
    if s1 < 0:
        c1 = pow(c1, -1, N)
        s1 = -s1
    if s2 < 0:
        c2 = pow(c2, -1, N)
        s2 = -s2
    
    m = (pow(c1, s1, N) * pow(c2, s2, N)) % N
    flag = long_to_bytes(m)
    return flag.decode()

# ========== Challenge X: Hastad's Broadcast Attack ==========
def solve_X():
    e = 53
    cs = [
        16721787619574751937423482796048434027693145023382142871489214716426212645092992164956020660515171054979840236155876211900655106888149097184698682220469227913293725778492582769344054229895303281286368726831202638678441766118263477350592783421445114372349159885703336106899899849563288984795097613059809534812882944507545816284716024174351334005709423929694863209828917824710458461810873109364493416426930502092627490917309727891934058692118493216575237751700795546844927802485283635882946954259558761234365509260870340670823573302266950538023557880222090496993903973930055930827869003163649390965104540146593120052444,
        19600183957825280889380089753713057550173109239850312295585212842491508337472571205189565655789320922048920991888717443532043942623625611347507150064775595762748180249102960748075251795095006517129088346431670375322983511120463273592010853433085279429081931938801751542902379793960780846394668442055235716916392673549120336005786654264367000910585165432950401248791181445527857821079393365222754575462430486536898910688210226740273120604771722034622345810559883388611160595083160123159259149679175761907974799883770523357764966737252006497746011466700214094575811680513737053865991408429139123021878164966311715185265,
        1633123986005568422502593787368317335766621146283276196925836500917878258619679565904188339704276504631915117268219445584482617152165592268156311900346808202778317169294466904590105372602481571765848437982977635686422904795084288776133225753029747208889490934860104566929266600504763261791040150448540075463858657857193344229973682858037841375136666457143248174090492399085995738744992831095932249588117318762461399756888449434786213530820926278247452471757439611729223424774655279281046125666707246944674527638692765843645147230449712348058793888478826540081504744116500409984904371969014974749800990074916266440807
    ]
    Ns = [
        28068667642427528352773432755001650838540250439391696538802336596720831414055505810374348508222584571833531732858823413968133695177789102731864958320782216641331878450580920640979662440560746681844581258745283587794401823316199714074828984944199668884158869828798765120557217008476394042742690804825189586625663294488827221014811228466586630876674403349891017547191389608826455181215134300042348723997293748117533007161651844835165677817058269159298032381084842763793971307680099320083337655440634786371916834752821722616765526120151726301836714048246959439615850496747653135624215508293702594393448086303737543731641,
        21168708101579516233646719590201587621422228829411422269327829089750675057550179955651596366147368827069219873604393712561275874629556924210215360893060261379858208370807390606566400111290733903254141003054959376939354835419333727047349206760481438604061518970970249112636743779523114504525942132267855287914434971751295097342102334907271722829489114226586273185657751811133323944571210833878423214065090870962102852524177137017413529574175017616304941004369378867085110015329932969755493207548853884260891580900759136999772653662304501867164684879155616827317982940078663518229004276680696483213977269820393789788083,
        19850410130397872861983877606981613343891616796352632439685460443763270505910978082783128719405745295783579218677123308723348566907343763586811251808154148537782445468309202090770047294437670224724600052192449570038175087658632015413353801993791422377496503398538293579643542830317642871334071261729609505781758999705744228941879298651561447470507228382543452278671985394940893818727715158092230539202290340791208572545743408831315409030665312471389360114884780631191552400938504577440268962699857692470815609237117088851062338413129683339391235473350191135960333933022583779453790039693469365210575417574066304301079
    ]
    
    # CRT
    # Need to use sage or implement CRT ourselves
    # For now, let's print instruction
    return "XH{USE_SAGE_CRT}"  # Placeholder


# ========== Challenge X: Hastad's Broadcast Attack ==========
def solve_X1():
    print("\n[X] Hastad's Broadcast Attack (CRT)")
    print("This requires SageMath. Save and run the following code in Sage:")
    print("""
# Save as solve_X.sage
e = 53
cs = [16721787619574751937423482796048434027693145023382142871489214716426212645092992164956020660515171054979840236155876211900655106888149097184698682220469227913293725778492582769344054229895303281286368726831202638678441766118263477350592783421445114372349159885703336106899899849563288984795097613059809534812882944507545816284716024174351334005709423929694863209828917824710458461810873109364493416426930502092627490917309727891934058692118493216575237751700795546844927802485283635882946954259558761234365509260870340670823573302266950538023557880222090496993903973930055930827869003163649390965104540146593120052444, 19600183957825280889380089753713057550173109239850312295585212842491508337472571205189565655789320922048920991888717443532043942623625611347507150064775595762748180249102960748075251795095006517129088346431670375322983511120463273592010853433085279429081931938801751542902379793960780846394668442055235716916392673549120336005786654264367000910585165432950401248791181445527857821079393365222754575462430486536898910688210226740273120604771722034622345810559883388611160595083160123159259149679175761907974799883770523357764966737252006497746011466700214094575811680513737053865991408429139123021878164966311715185265, 1633123986005568422502593787368317335766621146283276196925836500917878258619679565904188339704276504631915117268219445584482617152165592268156311900346808202778317169294466904590105372602481571765848437982977635686422904795084288776133225753029747208889490934860104566929266600504763261791040150448540075463858657857193344229973682858037841375136666457143248174090492399085995738744992831095932249588117318762461399756888449434786213530820926278247452471757439611729223424774655279281046125666707246944674527638692765843645147230449712348058793888478826540081504744116500409984904371969014974749800990074916266440807]
Ns = [28068667642427528352773432755001650838540250439391696538802336596720831414055505810374348508222584571833531732858823413968133695177789102731864958320782216641331878450580920640979662440560746681844581258745283587794401823316199714074828984944199668884158869828798765120557217008476394042742690804825189586625663294488827221014811228466586630876674403349891017547191389608826455181215134300042348723997293748117533007161651844835165677817058269159298032381084842763793971307680099320083337655440634786371916834752821722616765526120151726301836714048246959439615850496747653135624215508293702594393448086303737543731641, 21168708101579516233646719590201587621422228829411422269327829089750675057550179955651596366147368827069219873604393712561275874629556924210215360893060261379858208370807390606566400111290733903254141003054959376939354835419333727047349206760481438604061518970970249112636743779523114504525942132267855287914434971751295097342102334907271722829489114226586273185657751811133323944571210833878423214065090870962102852524177137017413529574175017616304941004369378867085110015329932969755493207548853884260891580900759136999772653662304501867164684879155616827317982940078663518229004276680696483213977269820393789788083, 19850410130397872861983877606981613343891616796352632439685460443763270505910978082783128719405745295783579218677123308723348566907343763586811251808154148537782445468309202090770047294437670224724600052192449570038175087658632015413353801993791422377496503398538293579643542830317642871334071261729609505781758999705744228941879298651561447470507228382543452278671985394940893818727715158092230539202290340791208572545743408831315409030665312471389360114884780631191552400938504577440268962699857692470815609237117088851062338413129683339391235473350191135960333933022583779453790039693469365210575417574066304301079]

# Use CRT
m_e = crt(cs, Ns)
m = int(m_e).nth_root(e)
flag = long_to_bytes(int(m))
print("XH{...} =", flag.decode())
""")
    return "XH{NEEDS_SAGEMATH}"

# ========== Challenge Y: Coppersmith's Attack ==========
def solve_Y():
    print("\n[Y] RSA Stereotyped Message Attack")
    print("This requires SageMath. Save and run the following code in Sage:")
    print("""
# Save as solve_Y.sage
N = 21161873715991769124703072345293932630019520479214234016560825401684220192315042434417683948395885232703893943884921899340522321536058821585333541915358424567477232436816597048441680480442904994385312266306269190688196305693797587503462864892361328472469952215039313473451818779611754244838454931910091460778214802891000983354161337052172673741291639502100774469953256053358600937905203340665537836339517311688774366620978758510109699084129318577262884954075584796055953495932620637522609382052737963861110688367463476017320127179737499572649141525752003433258974973246253757560921574734569180431919686495764210139981
c = 5777420435589578356628974775616571287704866959456802228465842863468361323351616571556260098477265221833174673817239921212940481743346287230844949479198565252816374869640400573355341838820295380712165942710516510254862691963993516500873254387179696031122383018327883432586805624054415420039620839193505702715398517281482482413489511915024032056150197992493515669564855161460043159113285147970848301510606445127634834024104288101089826727614120342511087698620486028846438448816898820869011441993394760197757764386160790831421166728443827597848643161019499744976274671769379024939363392836099387711096962884377731800306

prefix = b"While hiking in the Blue Mountains, I discovered '"
suffix = b"' carved into a rock. Pondering over this, I realized that even the silent stones have stories to share, reflecting the vast history of the landscapes they've witnessed."

P.<x> = PolynomialRing(Zmod(N))
m_known = bytes_to_long(prefix) * 2^(8*(255-len(prefix))) + x * 2^(8*len(suffix)) + bytes_to_long(suffix)
f = m_known^3 - c
roots = f.small_roots(X=2^(8*36), beta=1)
if roots:
    flag_num = int(roots[0])
    flag = long_to_bytes(flag_num)
    print("YH{...} =", flag.decode())
""")
    return "YH{NEEDS_SAGEMATH}"

# ========== Challenge Z: Franklin-Reiter ==========
def solve_Z():
    print("\n[Z] Franklin-Reiter Related Message Attack")
    print("This requires SageMath. Save and run the following code in Sage:")
    print("""
# Save as solve_Z.sage
N = 21605078068881498782819048171894829027309073706899700368320898306585692569989037051800262879920595007282368584236406267684936418879719173323944786406385213715891905152177564963981315245140222449203077248953976257742155758441359533536709300299774032366657788036496959849898683764666932427683272724861241129038445118071370266452729059517082678438816843970169034272974470329661409192276205785270099230147636829235755430320319707389119023770204763073024720205484886273151609846161749754508683921665139614833651876830883334247742161865123555983809999642252319169052590465069995573253351532504852901266961578272338670348367
c1 = 20089218479858612694242629777663519453555438534104822578338254908252825485555168585607069874403023659158601900966904607461556061179363779646899281413405668204871774675457671679099932808045201194210099049024788880294050051491419229120556495222935100682226453507983989606251414763340638571480730711098325171826346902088270238368040496910306420248481742415271335021113839576595773102490407287059707113189779830753044627646480909263574359295289454216148015482931568652052152387684496751707446168856385928092263914090401410627266896526096381247889671896046414514726970393582242180759850215770998243593699056707258065976721
c2 = 14236892148098943164337721411692974730163960547674907615022561931081984144229688171308450922544422961947426528739391762153632741583812585497948857606734539972523531926832301391236401056088640551645968433318349696980756200528910118847311480716708709013429456196969580146807420590558344526274313594042078868372704483528552650368559605162179909839280262676459977669829718309859007620479317684014569952158458423989126993861240170358147782735447826070828305061331148105071764701997542648582064971479024870758180153911358592632223377041090010869291669220105455258397696022064995487923850969816982093551773993650215106923790
e = 12323

P.<x> = PolynomialRing(Zmod(N))
prefix_shift = bytes_to_long(b"My last flag is ") * 2^(8*232)
suffix_val = bytes_to_long(b" is secret")
a = prefix_shift - suffix_val

f1 = (x + a)^e - c1
f2 = x^e - c2
result = gcd(f1, f2)
if result.degree() == 1:
    flag_num = -int(result.coefficients()[0])
    flag = long_to_bytes(flag_num)
    print("ZH{...} =", flag.decode())
""")
    return "ZH{NEEDS_SAGEMATH}"

# ========== Main ==========
if __name__ == "__main__":
    print("\nSolving A-F with Python...")
    
    results = {}
    for name, func in [('A', solve_A), ('B', solve_B), ('C', solve_C), 
                       ('P', solve_P), ('Q', solve_Q), ('R', solve_R)]:
        try:
            results[name] = func()
            print(f"{name}: {results[name]}")
        except Exception as e:
            print(f"{name}: Error - {e}")
    
    print("\n" + "="*60)
    print("Challenges X, Y, Z require SageMath:")
    print("="*60)
    solve_X()
    solve_Y()
    solve_Z()
    
    print("\n" + "="*60)
    print("Summary of solved flags:")
    print("="*60)
    for k, v in results.items():
        print(f"{k}: {v}")
