from itertools import product

# long_to_bytes ì§ì ‘ êµ¬í˜„
def long_to_bytes(n):
    """ì •ìˆ˜ë¥¼ ë°”ì´íŠ¸ë¡œ ë³€í™˜"""
    if n == 0:
        return b'\x00'
    
    bytes_list = []
    while n > 0:
        bytes_list.append(n & 0xff)
        n >>= 8
    
    return bytes(reversed(bytes_list))

# ========================================
# Level 1, 2ì—ì„œ ë³µêµ¬í•œ 21ê°œì˜ ì†Œìˆ˜ (í•˜ë“œì½”ë”©)
# ========================================
primes = [
    56623246094920665877294953899,
    70298377313312812421132369639,
    43239492116307914726546913079,
    50984833815895431511237985123,
    57336437034737904130521347579,
    41582963239898826939274795531,
    48985225744777972635762106859,
    76433954787771906982750512203,
    55212299981378307680084143343,
    49416944267573747001174976999,
    52657009975350668532396056951,
    65858382914815624939852669127,
    51784640101552362763297237859,
    59637051300500617602118039571,
    74672574737794355383492052023,
    42462586457497344136034294371,
    69201277256591649307226837971,
    55528397644599221906129778691,
    72598006614308373553036917943,
    77741729491442341302288715303,
    57020063117746635284743923199
]

# Level 3 ë°ì´í„°
n = 8975502133751214976596793703183778052411011900177500243768777282330816642056981805811790381829483492764428342215634574515821129324659800319669470444347308735098976382711415057849209479083341304289325588022365320881178773419236262216119250430093589879414038269150815374450628239576115768958852492475676545522400519332805393188998864390591853176252627728565672043111360212467611093427958594553564254039625861259945824906961382228127521282726473360953455128365565001878958661262632508365216646496027940234321884891930629986304239076793645107208143726178096518566384747230322225715547450298392435237613819683
c = 15461874548145497262627805918288797407669606228369032108253216879252263093191844833274031668859587655937562434306419833655956718859053870677478031885290931003134838826745094486914725551854018991339414554936128395837978778906901696598726392699093619066687473015344367916666146016716893963987699353447211290577314280308336887626612489

print("=" * 70)
print("Level 3 Rabin ë³µí˜¸í™” (21ê°œ ì†Œìˆ˜ í•˜ë“œì½”ë”©)")
print("=" * 70)

# ê²€ì¦
n_check = 1
for p in primes:
    n_check *= p

if n_check == n:
    print("âœ“ ì†Œìˆ˜ ê²€ì¦ ì™„ë£Œ!\n")
else:
    print("âš  ê²½ê³ : ì†Œìˆ˜ì˜ ê³±ì´ nê³¼ ë‹¤ë¦…ë‹ˆë‹¤!\n")

def crt(remainders, moduli):
    """ì¤‘êµ­ì¸ì˜ ë‚˜ë¨¸ì§€ ì •ë¦¬"""
    total = 0
    prod = 1
    for m in moduli:
        prod *= m
    
    for r, m in zip(remainders, moduli):
        p = prod // m
        total += r * pow(p, -1, m) * p
    
    return total % prod

# ê° ì†Œìˆ˜ì— ëŒ€í•´ ì œê³±ê·¼ ê³„ì‚°
print("ê° ì†Œìˆ˜ modì—ì„œ ì œê³±ê·¼ ê³„ì‚° ì¤‘...")
roots = []
for p in primes:
    if p % 4 != 3:
        print(f"  ê²½ê³ : p % 4 = {p % 4}")
        continue
    
    # p â‰¡ 3 (mod 4)ì¼ ë•Œ: m â‰¡ Â±c^((p+1)/4) (mod p)
    mp = pow(c, (p + 1) // 4, p)
    roots.append((mp, p))

print(f"âœ“ {len(roots)}ê°œ ì†Œìˆ˜ì—ì„œ ì œê³±ê·¼ ê³„ì‚° ì™„ë£Œ\n")

# ì „ëµ: ëœë¤í•˜ê²Œ ì—¬ëŸ¬ ì¡°í•© ì‹œë„ + ì²´ê³„ì  íƒìƒ‰
print("CRTë¡œ í‰ë¬¸ í›„ë³´ ìƒì„± ì¤‘...\n")

found = False
candidates_checked = 0

# ëª¨ë“  ì¡°í•© íƒìƒ‰ (2^21 = 2,097,152 ê°€ì§€)
total_combinations = 2 ** len(roots)
print(f"[ì „ì²´ íƒìƒ‰] ì´ {total_combinations:,}ê°œ ì¡°í•© ì‹œë„...")
print("(ì•½ 2~5ë¶„ ì†Œìš” ì˜ˆìƒ)\n")

for i, signs in enumerate(product([1, -1], repeat=len(roots))):
    
    try:
        remainders = [(r * sign) % p for (r, p), sign in zip(roots, signs)]
        moduli = [p for _, p in roots]
        m = crt(remainders, moduli)
        
        candidates_checked += 1
        
        # ì§„í–‰ ìƒí™© í‘œì‹œ (10ë§Œ ê°œë§ˆë‹¤)
        if candidates_checked % 100000 == 0:
            percentage = (candidates_checked / total_combinations) * 100
            print(f"  {candidates_checked:,}ê°œ í™•ì¸... ({percentage:.1f}%)")
        
        # flag í¬ê¸° ì¶”ì • (ì¼ë°˜ì ìœ¼ë¡œ 100~500ë¹„íŠ¸)
        if 100 < m.bit_length() < 1000:
            try:
                flag_bytes = long_to_bytes(m)
                
                # DH{ íŒ¨í„´ ì²´í¬
                if b'DH{' in flag_bytes:
                    flag_str = flag_bytes.decode('ascii', errors='ignore')
                    print(f"\nğŸš© FLAG ë°œê²¬! (ì¡°í•© #{i})")
                    print(f"   {flag_str}\n")
                    found = True
                    break
                
                # ì½ì„ ìˆ˜ ìˆëŠ” ë¬¸ìì—´ì¸ì§€ ì²´í¬
                if len(flag_bytes) > 10 and all(32 <= b < 127 for b in flag_bytes):
                    flag_str = flag_bytes.decode('ascii')
                    if any(pattern in flag_str for pattern in ['flag', 'FLAG', 'ctf', 'CTF', '{']):
                        print(f"\nğŸš© ê°€ëŠ¥í•œ FLAG ë°œê²¬! (ì¡°í•© #{i})")
                        print(f"   {flag_str}\n")
            except:
                pass
    except:
        pass

if not found:
    print(f"\nâš  ëª¨ë“  {total_combinations:,}ê°œ ì¡°í•©ì„ í™•ì¸í–ˆì§€ë§Œ flagë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
    print("   - ì†Œìˆ˜ê°€ í‹€ë ¸ê±°ë‚˜")
    print("   - flag íŒ¨í„´ì´ ì˜ˆìƒê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
else:
    print(f"\nâœ“ ì´ {candidates_checked:,}ê°œ ì¡°í•© ì¤‘ì—ì„œ flag ë°œê²¬!")

print("\n" + "=" * 70)
print("íƒìƒ‰ ì™„ë£Œ!")
print("=" * 70)