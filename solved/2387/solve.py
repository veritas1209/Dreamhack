from sympy import factorint
from math import gcd
from itertools import product

# long_to_bytes ì§ì ‘ êµ¬í˜„ (Crypto ì—†ì´)
def long_to_bytes(n):
    """ì •ìˆ˜ë¥¼ ë°”ì´íŠ¸ë¡œ ë³€í™˜"""
    if n == 0:
        return b'\x00'
    
    bytes_list = []
    while n > 0:
        bytes_list.append(n & 0xff)
        n >>= 8
    
    return bytes(reversed(bytes_list))

# ========================================
# ë¬¸ì œì—ì„œ ì£¼ì–´ì§„ ë°ì´í„°
# ========================================
x1 = [5892358770576851944010194779142018408155269683352377230085, 1694336677401205962139311720952097565100191356061224077131, 1117187172795656310152683943643284989494459111219889483535, 1209496234460555068351660279875019914921094277054458499713, 2067837922911917660459721745652030221064949224314398312705, 578740124124809504290306095713189274365030502910993131782, 1832239101007859711285956616251988975956123048584254478958]
x2 = [2013082176627958219899152142827760558588138877094933058632, 1229180282080586442669109626620027760102058948975896647258, 4443990447520328977906454834063047549863229488358434051286, 2238595894232025556881612587352542933432302168304489583584, 1021223564259233692918536093625982056297466027706555132248, 2361320481510332482544762085401842041234030948710525727135, 4231649063911843191358128939746780008835005414248250661775]
r_c = [1286115116984031812569353744445368556790531224432465748660, 2078861157806481085074549808983701252914733914897532086553, 465081297744334067033259055398746019612178858559030817016, 398387169615859315047873871045543010112569570532199953189, 1330701952994321238381952349141448199248888892187205197827, 2892778762620743092764267465632502497140472836345956864461, 3228004616708985585395070532849357534162835536086755874070]
n = 8975502133751214976596793703183778052411011900177500243768777282330816642056981805811790381829483492764428342215634574515821129324659800319669470444347308735098976382711415057849209479083341304289325588022365320881178773419236262216119250430093589879414038269150815374450628239576115768958852492475676545522400519332805393188998864390591853176252627728565672043111360212467611093427958594553564254039625861259945824906961382228127521282726473360953455128365565001878958661262632508365216646496027940234321884891930629986304239076793645107208143726178096518566384747230322225715547450298392435237613819683
c = 15461874548145497262627805918288797407669606228369032108253216879252263093191844833274031668859587655937562434306419833655956718859053870677478031885290931003134838826745094486914725551854018991339414554936128395837978778906901696598726392699093619066687473015344367916666146016716893963987699353447211290577314280308336887626612489
e = 65537

print("=" * 70)
print("CTF ë³µí˜¸í™” ì‹œì‘!")
print("=" * 70)

# ========================================
# Level 1: XOR ë³µêµ¬
# ========================================
print("\n[LEVEL 1] XOR ë‚œë…í™” í•´ì œ")
print("-" * 70)

r_n = []
for i in range(len(x1)):
    recovered_n = x1[i] ^ x2[i]
    r_n.append(recovered_n)
    print(f"r_n[{i}] ë³µêµ¬ ì™„ë£Œ (ë¹„íŠ¸ ê¸¸ì´: {recovered_n.bit_length()})")

print(f"\nâœ“ ì´ {len(r_n)}ê°œì˜ RSA ëª¨ë“ˆëŸ¬ìŠ¤ ë³µêµ¬ ì™„ë£Œ!")

# ========================================
# Level 2: RSA ë³µí˜¸í™”ë¡œ ì†Œìˆ˜ ë³µêµ¬
# ========================================
print("\n" + "=" * 70)
print("[LEVEL 2] RSA ë³µí˜¸í™” ë° ì†Œìˆ˜ ë³µêµ¬")
print("-" * 70)

primes = []

for i in range(len(r_n)):
    print(f"\nê·¸ë£¹ {i+1}/7 ì²˜ë¦¬ ì¤‘...")
    print(f"  ëª¨ë“ˆëŸ¬ìŠ¤: {r_n[i]}")
    
    # ì¸ìˆ˜ë¶„í•´
    print(f"  ì¸ìˆ˜ë¶„í•´ ì‹œì‘... (ë¹„íŠ¸ ê¸¸ì´: {r_n[i].bit_length()})")
    factors = factorint(r_n[i])
    factor_list = []
    for prime, exp in factors.items():
        factor_list.extend([prime] * exp)
    
    if len(factor_list) != 2:
        print(f"  âš  ê²½ê³ : ì¸ìˆ˜ê°€ 2ê°œê°€ ì•„ë‹™ë‹ˆë‹¤! (ê°œìˆ˜: {len(factor_list)})")
        continue
    
    p, q = sorted(factor_list)
    print(f"  âœ“ p = {p}")
    print(f"  âœ“ q = {q}")
    
    # RSA ë³µí˜¸í™”
    phi = (p - 1) * (q - 1)
    
    if gcd(e, phi) != 1:
        print(f"  âœ— ì˜¤ë¥˜: eì™€ Ï†(n)ì´ ì„œë¡œì†Œê°€ ì•„ë‹™ë‹ˆë‹¤!")
        continue
    
    d = pow(e, -1, phi)
    m = pow(r_c[i], d, r_n[i])
    
    print(f"  âœ“ ë³µí˜¸í™”ëœ ì†Œìˆ˜: {m}")
    
    # p, q, mì„ primes ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
    primes.extend([p, q, m])

print(f"\nâœ“ ì´ {len(primes)}ê°œì˜ ì†Œìˆ˜ ë³µêµ¬ ì™„ë£Œ!")

# ë³µêµ¬í•œ ì†Œìˆ˜ë“¤ì´ nì˜ ì¸ìˆ˜ì¸ì§€ ê²€ì¦
print("\nê²€ì¦ ì¤‘...")
n_reconstructed = 1
for p in primes:
    n_reconstructed *= p

if n_reconstructed == n:
    print("âœ“ ë³µêµ¬í•œ ì†Œìˆ˜ë“¤ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤!")
else:
    print("âš  ê²½ê³ : ë³µêµ¬í•œ ì†Œìˆ˜ì˜ ê³±ì´ nê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")

# ========================================
# Level 3: Rabin ë³µí˜¸í™”
# ========================================
print("\n" + "=" * 70)
print("[LEVEL 3] Rabin ë³µí˜¸í™” (CRT ì‚¬ìš©)")
print("-" * 70)

def crt(remainders, moduli):
    """ì¤‘êµ­ì¸ì˜ ë‚˜ë¨¸ì§€ ì •ë¦¬"""
    total = 0
    prod = 1
    for m in moduli:
        prod *= m
    
    for r, m in zip(remainders, moduli):
        p = prod // m
        total += r * pow(p, -1, m) * p
    
    return total % prod

# ê° ì†Œìˆ˜ì— ëŒ€í•´ ì œê³±ê·¼ ê³„ì‚°
print("ê° ì†Œìˆ˜ modì—ì„œ ì œê³±ê·¼ ê³„ì‚° ì¤‘...")
roots = []
for idx, p in enumerate(primes):
    if p % 4 != 3:
        print(f"  ì†Œìˆ˜ {idx}: p % 4 = {p % 4} (3ì´ ì•„ë‹˜!)")
        continue
    
    # p â‰¡ 3 (mod 4)ì¼ ë•Œ: m â‰¡ Â±c^((p+1)/4) (mod p)
    mp = pow(c, (p + 1) // 4, p)
    roots.append((mp, p))

print(f"âœ“ {len(roots)}ê°œ ì†Œìˆ˜ì—ì„œ ì œê³±ê·¼ ê³„ì‚° ì™„ë£Œ")

# ê°€ëŠ¥í•œ ì¡°í•© ì‹œë„ (ë” ë§ì´)
print("\nCRTë¡œ ê°€ëŠ¥í•œ í‰ë¬¸ ê³„ì‚° ì¤‘...")
candidates = set()

# ë” ë§ì€ ì¡°í•© ì‹œë„ (ìµœëŒ€ 100ë§Œ ê°œ)
num_combinations = min(2**20, 2**len(roots))  # ìµœëŒ€ 100ë§Œ ê°œ ì¡°í•©
print(f"ìµœëŒ€ {num_combinations}ê°œ ì¡°í•© ì‹œë„...")

count = 0
for signs in product([1, -1], repeat=len(roots)):
    if count >= num_combinations:
        break
    
    try:
        remainders = [(r * sign) % p for (r, p), sign in zip(roots, signs)]
        moduli = [p for _, p in roots]
        m = crt(remainders, moduli)
        
        # flagëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì‘ì€ ê°’
        if m.bit_length() < 2000:
            candidates.add(m)
            
            # ì‹¤ì‹œê°„ìœ¼ë¡œ flag íŒ¨í„´ ì²´í¬
            if count % 10000 == 0 and count > 0:
                try:
                    flag_bytes = long_to_bytes(m)
                    if b'DH{' in flag_bytes or b'flag{' in flag_bytes or b'FLAG{' in flag_bytes:
                        print(f"\nğŸš© FLAG ë°œê²¬ (ì¡°í•© #{count})!")
                        print(f"   {flag_bytes.decode('ascii', errors='ignore')}")
                        break
                except:
                    pass
    except Exception as e:
        pass
    
    count += 1
    if count % 50000 == 0:
        print(f"  {count}ê°œ ì¡°í•© ì‹œë„ ì™„ë£Œ... (í˜„ì¬ {len(candidates)}ê°œ í›„ë³´)")

print(f"\nâœ“ {len(candidates)}ê°œì˜ ê³ ìœ í•œ í›„ë³´ ë°œê²¬")

# ========================================
# Flag íƒìƒ‰
# ========================================
print("\n" + "=" * 70)
print("[FLAG íƒìƒ‰]")
print("-" * 70)

found_flags = []

# í¬ê¸° ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ í™•ì¸
sorted_candidates = sorted(candidates, key=lambda x: x.bit_length())

print(f"ì´ {len(sorted_candidates)}ê°œ í›„ë³´ ê²€ì‚¬ ì¤‘...\n")

for i, m in enumerate(sorted_candidates):
    try:
        flag_bytes = long_to_bytes(m)
        
        # printable ASCII ë¬¸ìë§Œ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸
        if len(flag_bytes) > 5 and all(32 <= b < 127 for b in flag_bytes):
            flag_str = flag_bytes.decode('ascii')
            
            # flag íŒ¨í„´ í™•ì¸ (ë” ë„“ê²Œ)
            if any(pattern in flag_str for pattern in ['DH{', 'flag{', 'FLAG{', 'ctf{', 'CTF{']):
                print(f"ğŸš© FLAG ë°œê²¬!")
                print(f"   {flag_str}\n")
                found_flags.append(flag_str)
            elif len(flag_str) > 10 and len(flag_str) < 200:
                # ì½ì„ ìˆ˜ ìˆëŠ” ë¬¸ìì—´ì´ë©´ ì¼ë‹¨ ì¶œë ¥
                if i < 50:  # ì²˜ìŒ 50ê°œë§Œ
                    print(f"í›„ë³´ {i+1}: {flag_str}")
    except:
        pass

print("\n" + "=" * 70)
if found_flags:
    print(f"âœ“ ë³µí˜¸í™” ì„±ê³µ! {len(found_flags)}ê°œì˜ flag ë°œê²¬")
    for flag in found_flags:
        print(f"  ğŸš© {flag}")
else:
    print("âš  Flagë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë” ë§ì€ ì¡°í•©ì„ ì‹œë„í•´ë³´ì„¸ìš”.")
    print("  (ì½”ë“œì˜ num_combinations ê°’ì„ ëŠ˜ë ¤ë³´ì„¸ìš”)")
print("=" * 70)