from Crypto.Util.number import *
from tqdm import trange

# Hardcoded ciphertext values
N = 13598153154833637656818517220292744946788560583202271669901644497177188925057767594849738947760162557359993013941391365772760007445899524368318435830676981817869673331870320737330775671648984463969468621798675109684957542627082360473783145645163195229452107363085083258061770951116708326158577900955824955580368937846998203862237667423531218641802533914520455768252943768258927701410136655514715642813622386907691909497053923779237421603983819718385274631056656164913952692683677249557675196144295524011209128894457571141496385889368393134706462736219400077160407228213790054598648594900234976787858245149588928960833
e = 257
f_enc = 73030397489099035279319855876886070810220785465128177783721084297465432817625336278147155884719651609504955461626696472226952698687233692421868683109668418808721348267656762914374932598845711762635302313777700950638040111032350897518341089453486878658752043973075172018407361437099018715978298553803310145104409716664859214032127299409390714013989919916925043280767966542091117410879060785455668156731917964298043856173226330939889557079289189362452492120327774680559927819819318320757393827478407474666372553788179255657267753672542551199879923864602793613493560797273359691934240752456707850607374109729242957842
l_enc = 6825921200349018807592335703838432756553045344446552588201212894686478236555882317769002755040398386112516580071466306416980142838663872816104291019190292985262727159441917005019446973370290161687441469000543372114223121684652244269880489000376504530684131188689017789471615206507470670355039250137661131451746230811543561823505247817951434369253704777477653801136551022141872820041695930382231777466427220328067948143423045759378273927189539190771224135246712538904597020537140232746518680426526607221858502476407003978155063780019151756163019505238511043244276199463778365406677436273087709538658354614028117605582
ag_enc = 13405734267473132964260648663662344691844124982067327807881447856906250215686955458840289075308599292884212579562070237306595813776114395770150100351698547278532462839559854176530380866034504401927460008482371273242234325195162560776433353563575265714310904078717547709421045819664460331652434824032359065910161206241508170553957699730174000953561319613897164604349886114030816663906511303410418434744417978755078997530231897836134105477564039394202236695430108076055265480289187871498243928056441475859991691886765082969555596956305613394840885959746799424044011106435318927874502200386083084292536310499299783132802
flag_enc = 3056721804126947156716832420271562440267433769620752944594737373742274947913485305137112373038501559035048723290582397238429559201578142286878226849109459842475726175229206479884282120253887765565064942559084499366369714492364454013309271233067776222260569521165957785067838323358689331121321008119215549159710593434825687954850384499195220170098401040423113540443602023460964321711666489448380410860143657566323543041994634505475840126749840054856691763832258809835642024521361484290659719157960232861905750980614338555945530164284419245959143626705465690336586407187101019404335441902329298015796866670034526063722

N, e, f_enc, l_enc, ag_enc, flag_enc = map(ZZ, (N, e, f_enc, l_enc, ag_enc, flag_enc))

# Step 1.
Q.<y> = PolynomialRing(Zmod(N))
P.<x> = PolynomialRing(Q)
f1 = P((x * 256^51 + y * 256^34 + 1)^e - (flag_enc / ag_enc) % N)
f2 = P(x^e - (f_enc / ag_enc) % N)
f3 = Q(y^e - (l_enc / ag_enc) % N)
for _ in trange(513): # work same as while f2.degree() > 0, but with progress bar
        f1_coef = f1[f1.degree()]
        f2_coef = f2[f2.degree()]
        f1 *= f2_coef
        f2 *= f1_coef
        f1 = P([coef % f3 for coef in list(f1)])
        f2 = P([coef % f3 for coef in list(f2)])
        f1 -= f2 * x^(f1.degree() - f2.degree())
        if f1.degree() < f2.degree():
                f1, f2 = f2, f1
g = f2[0]

# Step 2.
g1 = g
g2 = f3
while g2.degree() > 0:
        g1 = g1 % g2
        g1, g2 = g2, g1
assert g1.degree() == 1
b = ZZ(-g1.monic()[0]) # recovered b
P.<x> = PolynomialRing(Zmod(N))
f1 = P((x * 256^51 + b * 256^34 + 1)^e - (flag_enc / ag_enc) % N)
f2 = P(x^e - (f_enc / ag_enc) % N)
while f2.degree() > 0:
        f1 = f1 % f2
        f1, f2 = f2, f1
assert f1.degree() == 1
a = ZZ(-f1.monic()[0]) # recovered a

# Step 3.
M = Matrix([[1, a], [0, N]])
ag_base = ZZ(M.LLL()[0][0])
ag_base = abs(ag_base)
ag = ag_base
while True:
        try:
                long_to_bytes(ag).decode()
                break
        except:
                ag += ag_base
f = a * ag % N
l = b * ag % N
flag = int(f).to_bytes(17, "big") + int(l).to_bytes(17, "big") + int(ag).to_bytes(34, "big")
print(flag.decode())